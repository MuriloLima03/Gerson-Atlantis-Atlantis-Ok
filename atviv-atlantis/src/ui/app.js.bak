// @ts-nocheck
/* eslint-disable */
// @ts-ignore
// @jsx-ignore
// @ts-ignore-next
// @ts-ignore-file

// Disable TypeScript JSX checking for this file since we're using template literals
/* @jsxRuntime classic */
/* @jsx-ignore */

// Atlantis SPA prototype
// Simple hash-router and localStorage-backed CRUD for Clients, Accommodations and Bookings

/* eslint-disable */
// @ts-nocheck

// Import the API adapter
const api = window.api;

if (!api) {
  console.error('API adapter not found! Make sure api.js is loaded before app.js');
}

// --- Storage helpers
async function load(collection) {
  try {
    switch(collection) {
      case 'atlantis_clients_v1':
        return await api.clients.list();
      case 'atlantis_accommodations_v1':
        return await api.accommodations.list();
      case 'atlantis_bookings_v1':
        return await api.bookings.list();
      default:
        console.warn('Unknown collection:', collection);
        return [];
    }
  } catch(e) {
    console.error('Failed to load data:', e);
    return [];
  }
}

async function save(collection, data) {
  try {
    switch(collection) {
      case 'atlantis_clients_v1':
        return await api.clients.save(data);
      case 'atlantis_accommodations_v1':
        return await api.accommodations.save(data);
      case 'atlantis_bookings_v1':
        return await api.bookings.save(data);
      default:
        console.warn('Unknown collection:', collection);
    }
  } catch(e) {
    console.error('Failed to save data:', e);
    throw e;
  }
}

// --- Seed sample data if empty
async function seedIfEmpty(){
  try {
    // Check if we have any data
    const clients = await load(LS_KEYS.clients);
    const accommodations = await load(LS_KEYS.accommodations);
    const bookings = await load(LS_KEYS.bookings);

    if (clients.length === 0 && accommodations.length === 0 && bookings.length === 0) {
      console.log('Database is empty, seeding sample data...');
      // Sample data will be added by the server
      return true;
    }
    return false;
  } catch(e) {
    console.error('Failed to check/seed data:', e);
    return false;
  }

  // Clients
  let clients = await loadEither(LS_KEYS.clients);
  if(!clients || clients.length === 0){
    const defaultClients = [
      { id: genId(), Nome: 'Admin Demo', nome: 'Admin Demo', name: 'Admin Demo', email: 'admin@example.com', Telefones: [{Ddd:'11',Numero:'999990000'}] },
      { id: genId(), Nome: 'Maria Silva', nome: 'Maria Silva', name: 'Maria Silva', email: 'maria@example.com', Telefones: [{Ddd:'11',Numero:'999990001'}] }
    ];
    await saveEither(LS_KEYS.clients, defaultClients);
    clients = await loadEither(LS_KEYS.clients);
  }

  // Accommodations
  let accs = await loadEither(LS_KEYS.accommodations);
  if(!accs || accs.length === 0){
    const defaultAcc = [
      { id: genId(), name: 'Quarto Solteiro Simples', type: 'SolteiroSimples', CamaSolteiro:1, CamaCasal:0, Climatizacao:false, Garagem:0, Suite:0, rate:120 },
      { id: genId(), name: 'Apartamento Família', type: 'FamiliaMais', CamaSolteiro:2, CamaCasal:1, Climatizacao:true, Garagem:1, Suite:1, rate:320 }
    ];
    await saveEither(LS_KEYS.accommodations, defaultAcc);
    accs = await loadEither(LS_KEYS.accommodations);
  }

  // Bookings: create a sample booking referencing the first client and first accommodation if bookings empty
  let bookings = await loadEither(LS_KEYS.bookings);
  if(!bookings || bookings.length === 0){
    try{
      // ensure we have fresh clients and accs (server may have assigned new ids)
      clients = await loadEither(LS_KEYS.clients);
      accs = await loadEither(LS_KEYS.accommodations);
      const clientId = (clients && clients[0] && (clients[0].id || clients[0]._id || clients[0].Id)) ? (clients[0].id || clients[0]._id || clients[0].Id) : genId();
  const accId = (accs && accs[0] && (accs[0].id || accs[0]._id || accs[0].Id)) ? (accs[0].id || accs[0]._id || accs[0].Id) : genId();
      const from = new Date(); const to = new Date(from); to.setDate(from.getDate()+2);
      const defaultBook = [{ id: genId(), clientId, accommodationId: accId, from: from.toISOString().split('T')[0], to: to.toISOString().split('T')[0], notes: 'Reserva inicial' }];
      await saveEither(LS_KEYS.bookings, defaultBook);
    }catch(e){ console.warn('failed creating default booking', e); }
  }
}

function genId(){ return 'id_' + Math.random().toString(36).slice(2,9); }

// --- Router
function navigate(){
  const hash = location.hash.replace(/^#\//,'') || '';
  const main = document.getElementById('app');
  setActiveNav();
  if(hash.startsWith('clients')) renderClients(main, hash);
  else if(hash.startsWith('accommodations')) renderAccommodations(main, hash);
  else if(hash.startsWith('bookings')) renderBookings(main, hash);
  else renderHome(main);
}

function setActiveNav(){
  document.querySelectorAll('.topbar nav a').forEach(a=>a.classList.remove('active'));
  const path = location.hash || '#/';
  const el = document.querySelector(`.topbar nav a[href="${path}"]`);
  if(el) el.classList.add('active');
}

// --- Home
function renderHome(container){
  container.innerHTML = `
    <section class="card">
      <h2>Bem-vindo ao protótipo</h2>
      <p class="small">Use a navegação acima para acessar Clientes, Acomodações e Hospedagens. Os dados são salvos localmente no seu navegador (localStorage).</p>
    </section>
    <section class="card">
      <h3>Resumo</h3>
      <div id="summary" class="grid"></div>
    </section>
  `;
  renderSummary();
}

async function renderSummary(){
  const el = document.getElementById('summary');
  if (!el) return;
  
  try {
    const [clients, acc, bookings] = await Promise.all([
      window.apiAdapter.load(LS_KEYS.clients),
      window.apiAdapter.load(LS_KEYS.accommodations),
      window.apiAdapter.load(LS_KEYS.bookings)
    ]);

    el.innerHTML = `
      <div class="card"><strong>${clients ? clients.length : 0}</strong><div class="small">Clientes</div></div>
      <div class="card"><strong>${acc ? acc.length : 0}</strong><div class="small">Acomodações</div></div>
      <div class="card"><strong>${bookings ? bookings.length : 0}</strong><div class="small">Hospedagens</div></div>
    `;
  } catch (err) {
    console.error('Failed to load summary:', err);
    el.innerHTML = '<div class="error">Erro ao carregar resumo</div>';
  }
}

// --- Clients
function renderClients(container, hash){
  container.innerHTML = `
    <div class="grid">
      <div class="card list">
        <div class="toolbar"><h2>Clientes</h2><button class="btn" id="btn-new-client">Novo Cliente</button></div>
        <div id="clients-list"></div>
      </div>
      <div class="card" id="clients-form-area">
        <div class="empty">Selecione um cliente ou clique em "Novo Cliente"</div>
      </div>
    </div>
  `;
  document.getElementById('btn-new-client').addEventListener('click', ()=> showClientForm());
  renderClientsList();
  if(hash.includes('edit')){
    const id = hash.split('/')[1]; if(id) showClientForm(id);
  }
}

function renderClientsList(){
  const list = load(LS_KEYS.clients);
  const container = document.getElementById('clients-list');
  if(!list.length){ container.innerHTML = '<div class="empty">Nenhum cliente cadastrado</div>'; return; }
  container.innerHTML = list.map(c=>{
    const tipo = c.tipo || c.Tipo || 'titular';
    const titularName = (tipo === 'dependente') ? (c.titularName || (c.Titular && (c.Titular.Nome || c.Titular.name)) || c.titular || '') : '';
    // format phone
    let phoneDisplay = '';
    if(c.Telefones && c.Telefones.length){ const t = c.Telefones[0]; phoneDisplay = `(${t.Ddd||''}) ${t.Numero||''}`; }
    else if(c.phone) phoneDisplay = c.phone;
    else if(c.Telefones === undefined && c.telefones && c.telefones.length){ const t = c.telefones[0]; phoneDisplay = `(${t.Ddd||''}) ${t.Numero||''}`; }
    return `
    <div class="item">
      <div>
        <div><strong>${escapeHtml(c.name || c.nome)}</strong> ${tipo === 'dependente' ? '<span class="small">(dependente)</span>' : '<span class="small">(titular)</span>'}</div>
        <div class="small">${escapeHtml(c.email || '')} • ${escapeHtml(c.Pais || c.pais || '')} ${escapeHtml(phoneDisplay)} ${titularName? '• Titular: '+escapeHtml(titularName):''}</div>
      </div>
      <div class="actions">
        <button class="btn ghost" data-action="edit" data-id="${c.id}">Editar</button>
        <button class="btn ghost" data-action="delete" data-id="${c.id}">Excluir</button>
      </div>
    </div>
  `}).join('');
  container.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = btn.dataset.id;
      if(btn.dataset.action === 'edit') showClientForm(id);
      else if(btn.dataset.action === 'delete'){
        if(confirm('Excluir cliente?')){ removeClient(id); renderClientsList(); renderSummary(); }
      }
    })
  })
}

function showClientForm(id){
  const area = document.getElementById('clients-form-area');
  const clients = load(LS_KEYS.clients);
  const c = id ? clients.find(x=>x.id===id) : {id:'',name:'',email:'',phone:'',tipo:'titular',dependentes:[],documentos:[],nomeSocial:'',dataNascimento:''};
  // ensure arrays
  c.dependentes = c.dependentes || c.Dependentes || [];
  c.documentos = c.documentos || c.Documentos || [];

    area.innerHTML = `
    <h3>${c.id? 'Editar Cliente' : 'Novo Cliente'}</h3>
    <form id="client-form">
      <label>Nome<input type="text" name="name" value="${escapeHtml(c.name || c.nome || '')}" required /></label>
      <label>Nome social<input type="text" name="nomeSocial" value="${escapeHtml(c.nomeSocial || c.nomeSocial || '')}" /></label>
      <label>Data nascimento<input type="date" name="dataNascimento" value="${c.dataNascimento? c.dataNascimento.split('T')[0] : ''}" /></label>
      <label>Email<input type="text" name="email" value="${escapeHtml(c.email || '')}" /></label>
      <div class="row">
        <label style="width:120px">DDD<input type="text" name="phoneDdd" value="${escapeHtml((c.Telefones && c.Telefones[0] && c.Telefones[0].Ddd) || (c.telefones && c.telefones[0] && c.telefones[0].Ddd) || '')}" /></label>
        <label style="flex:1">Telefone<input type="text" name="phoneNumber" value="${escapeHtml((c.Telefones && c.Telefones[0] && c.Telefones[0].Numero) || (c.telefones && c.telefones[0] && c.telefones[0].Numero) || c.phone || '')}" /></label>
      </div>
      <fieldset style="margin-top:8px;padding:8px;border:1px solid #eef">
        <legend>Endereço</legend>
        <label>Rua<input type="text" name="end_rua" value="${escapeHtml((c.Endereco && c.Endereco.rua) || (c.endereco && c.endereco.rua) || '')}" /></label>
        <div class="row">
          <label style="width:120px">Número<input type="text" name="end_num" value="${escapeHtml((c.Endereco && c.Endereco.numero) || (c.endereco && c.endereco.numero) || '')}" /></label>
          <label style="flex:1">Cidade<input type="text" name="end_cidade" value="${escapeHtml((c.Endereco && c.Endereco.cidade) || (c.endereco && c.endereco.cidade) || '')}" /></label>
        </div>
        <div class="row">
          <label style="width:120px">Estado<input type="text" name="end_estado" value="${escapeHtml((c.Endereco && c.Endereco.estado) || (c.endereco && c.endereco.estado) || '')}" /></label>
          <label style="flex:1">CEP<input type="text" name="end_cep" value="${escapeHtml((c.Endereco && c.Endereco.cep) || (c.endereco && c.endereco.cep) || '')}" /></label>
        </div>
        <div class="row">
          <label>País<input type="text" name="end_pais" value="${escapeHtml((c.Endereco && c.Endereco.pais) || (c.endereco && c.endereco.pais) || '')}" /></label>
        </div>
      </fieldset>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn" type="submit">Salvar</button>
        <button class="btn ghost" id="btn-cancel-client" type="button">Cancelar</button>
      </div>
    </form>

    ${ (c.tipo === 'dependente' || c.Tipo === 'dependente') && (c.Titular || c.titular) ? `<div style="margin-top:10px"><strong>Titular:</strong> ${escapeHtml((c.Titular && (c.Titular.Nome || c.Titular.name)) || c.titularName || c.titular || '')}</div>` : '' }

    <section style="margin-top:14px">
      <h4>Documentos</h4>
      <div id="client-docs">
        ${c.documentos.length? c.documentos.map(d=>`
          <div class="item">
            <div class="small">${escapeHtml(d.tipo||d.Tipo||d.type)}: ${escapeHtml(d.numero||d.number)}</div>
            <div class="actions">
              <button class="btn ghost" data-action="edit-doc" data-id="${d.id}">Editar</button>
              <button class="btn ghost" data-action="delete-doc" data-id="${d.id}">Excluir</button>
            </div>
          </div>
        `).join('') : '<div class="empty">Nenhum documento</div>'}
      </div>
      <form id="doc-form" style="margin-top:10px">
        <div class="row">
          <label style="flex:1">Tipo<select name="tipo"><option>CPF</option><option>RG</option><option>PASSAPORTE</option></select></label>
          <label style="flex:2">Número<input type="text" name="numero" /></label>
        </div>
        <div style="margin-top:8px">
          <button class="btn" type="submit">Adicionar documento</button>
          <input type="hidden" name="docId" value="" />
        </div>
      </form>
    </section>

    <section style="margin-top:14px">
      <h4>Dependentes</h4>
      <div id="client-deps">
        ${c.dependentes.length? c.dependentes.map(d=>`<div class="small">${escapeHtml(d.name||d.Nome)}</div>`).join('') : '<div class="empty">Nenhum dependente</div>'}
      </div>
      ${c.tipo === 'titular' || c.Tipo === 'titular' || !c.id ? `
      <form id="dep-form" style="margin-top:10px">
        <div class="row">
          <label style="flex:1">Nome<input type="text" name="depName"></label>
          <label style="flex:1">Nome social<input type="text" name="depNomeSocial"></label>
        </div>
        <div class="row">
          <label>Data nascimento<input type="date" name="depNascimento"></label>
        </div>
        <div class="row" style="margin-top:8px">
          <label style="width:120px">DDD<input type="text" name="depDdd"></label>
          <label style="flex:1">Telefone<input type="text" name="depPhone"></label>
        </div>
        <fieldset style="margin-top:8px;padding:8px;border:1px solid #eef">
          <legend>Endereço do dependente</legend>
          <label>Rua<input type="text" name="dep_rua"></label>
          <div class="row">
            <label style="width:120px">Número<input type="text" name="dep_numero"></label>
            <label style="flex:1">Cidade<input type="text" name="dep_cidade"></label>
          </div>
        </fieldset>
        <div style="margin-top:8px"><button class="btn" type="submit">Adicionar dependente</button></div>
      </form>
      ` : ''}
    </section>
  `;

  document.getElementById('btn-cancel-client').addEventListener('click', ()=>{
    area.innerHTML = '<div class="empty">Selecione um cliente ou clique em "Novo Cliente"</div>';
  })

  document.getElementById('client-form').addEventListener('submit',(e)=>{
    e.preventDefault();
    const form = e.target;
    const endereco = { 
      rua: form.end_rua.value.trim(), 
      numero: form.end_num.value.trim(), 
      cidade: form.end_cidade.value.trim(), 
      estado: form.end_estado.value.trim(), 
      cep: form.end_cep.value.trim(),
      pais: form.end_pais.value.trim()
    };
    const telefones = [];
    if(form.phoneDdd.value || form.phoneNumber.value) telefones.push({ Ddd: form.phoneDdd.value.trim(), Numero: form.phoneNumber.value.trim() });
    const obj = { 
      id: c.id || genId(), 
      name: form.name.value.trim(), 
      nomeSocial: form.nomeSocial.value.trim(), 
      dataNascimento: form.dataNascimento.value,
      email: form.email.value.trim(), 
      Telefones: telefones, 
      Endereco: endereco, 
      tipo: c.tipo || c.Tipo || 'titular', 
      Documentos: c.documentos 
    };
    const clients = load(LS_KEYS.clients).filter(x=>x.id!==obj.id);
    clients.push(obj); save(LS_KEYS.clients, clients);
    renderClientsList(); renderSummary();
    area.innerHTML = '<div class="small">Cliente salvo com sucesso.</div>';
  })

  // document form and actions
  const docForm = document.getElementById('doc-form');
  const docsContainer = document.getElementById('client-docs');

  // Handle document edit/delete buttons
  docsContainer.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const docId = btn.dataset.id;
    const action = btn.dataset.action;
    const clients = load(LS_KEYS.clients);
    const idx = clients.findIndex(x => x.id === c.id);
    if (idx < 0) return;

    if (action === 'edit-doc') {
      const doc = clients[idx].Documentos.find(d => d.id === docId);
      if (doc) {
        docForm.tipo.value = doc.tipo;
        docForm.numero.value = doc.numero;
        docForm.docId.value = doc.id;
        docForm.querySelector('button[type="submit"]').textContent = 'Atualizar documento';
      }
    } else if (action === 'delete-doc') {
      if (confirm('Excluir documento?')) {
        clients[idx].Documentos = clients[idx].Documentos.filter(d => d.id !== docId);
        save(LS_KEYS.clients, clients);
        showClientForm(c.id);
      }
    }
  });

  // document form submit (add/edit)
  docForm.addEventListener('submit',(e)=>{
    e.preventDefault(); 
    const f = e.target;
    const doc = { 
      id: f.docId.value || genId(), 
      tipo: f.tipo.value, 
      numero: f.numero.value 
    };

    // attach to client in memory
    const clients = load(LS_KEYS.clients);
    const idx = clients.findIndex(x=>x.id===c.id);
    if(idx<0){ alert('Salve o cliente antes de adicionar documentos'); return; }
    
    clients[idx].Documentos = clients[idx].Documentos || [];
    
    if (f.docId.value) {
      // update existing
      const docIdx = clients[idx].Documentos.findIndex(d => d.id === f.docId.value);
      if (docIdx >= 0) {
        clients[idx].Documentos[docIdx] = doc;
      }
    } else {
      // add new
      clients[idx].Documentos.push(doc);
    }
    
    save(LS_KEYS.clients, clients);
    
    // reset form
    f.docId.value = '';
    f.tipo.value = 'CPF';
    f.numero.value = '';
    f.querySelector('button[type="submit"]').textContent = 'Adicionar documento';
    
    // refresh form area
    showClientForm(c.id);
  })

  // dependent form
  const depForm = document.getElementById('dep-form');
  if(depForm){
    depForm.addEventListener('submit',(e)=>{
      e.preventDefault(); const f=e.target;
      const enderecoDep = { rua: f.dep_rua.value.trim(), numero: f.dep_numero.value.trim(), cidade: f.dep_cidade.value.trim() };
      const telefones = [];
      if(f.depDdd.value || f.depPhone.value) telefones.push({ Ddd: f.depDdd.value.trim(), Numero: f.depPhone.value.trim() });
      const dep = { id: genId(), name: f.depName.value.trim(), nomeSocial: f.depNomeSocial.value.trim(), dataNascimento: f.depNascimento.value, tipo: 'dependente', Titular: { id: c.id, name: c.name }, Dependentes: [], Documentos: [], Endereco: enderecoDep, Telefones: telefones };
      const clients = load(LS_KEYS.clients);
      // add to titular dependentes array
      const idx = clients.findIndex(x=>x.id===c.id);
      if(idx<0){ alert('Salve o cliente antes de adicionar dependentes'); return; }
      clients[idx].Dependentes = clients[idx].Dependentes || [];
      clients[idx].Dependentes.push(dep);
      // also push dependent as separate client record
      clients.push(dep);
      save(LS_KEYS.clients, clients);
      // refresh
      showClientForm(c.id);
    })
  }
}

function removeClient(id){
  const clients = load(LS_KEYS.clients);
  const target = clients.find(x=>x.id===id);
  if(!target) return;
  const tipo = target.tipo || target.Tipo || 'titular';
  if(tipo === 'dependente'){
    // remove from titular's dependentes array
    if(target.Titular || target.titular){
      const titularId = (target.Titular && (target.Titular.id || target.Titular)) || target.titular || (target.Titular && target.Titular.id);
      const tIdx = clients.findIndex(x=>x.id===titularId);
      if(tIdx>=0){ clients[tIdx].Dependentes = (clients[tIdx].Dependentes || []).filter(d=> (d.id || d) !== id); }
    }
    const remaining = clients.filter(x=>x.id!==id);
    save(LS_KEYS.clients, remaining);
    // remove bookings referencing this client
    const bookings = load(LS_KEYS.bookings).filter(b=>b.clientId!==id); save(LS_KEYS.bookings, bookings);
    return;
  }
  // titular: remove dependents and bookings
  const deps = (target.Dependentes || []).map(d=> d.id || d).filter(Boolean);
  let remaining = clients.filter(x=> !deps.includes(x.id) && x.id!==id);
  save(LS_KEYS.clients, remaining);
  const bookings = load(LS_KEYS.bookings).filter(b=> !deps.includes(b.clientId) && b.clientId!==id); save(LS_KEYS.bookings, bookings);
}

// --- Accommodations
async function renderAccommodations(container, hash){
  container.innerHTML = `
    <div class="grid">
      <div class="card list">
        <div class="toolbar"><h2>Acomodações</h2><div style="display:flex;gap:8px"><button class="btn" id="btn-new-acc">Nova Acomodação</button><button class="btn ghost" id="btn-show-types">Mostrar tipos</button></div></div>
        <div id="acc-list"></div>
      </div>
      <div class="card" id="acc-form-area"><div class="empty">Selecione uma acomodação ou crie uma nova</div></div>
    </div>
  `;
  
  document.getElementById('btn-new-acc').addEventListener('click', ()=> showAccForm());
  document.getElementById('btn-show-types').addEventListener('click', async ()=>{
    try {
      if (!window.apiAdapter) throw new Error('API adapter not available');
      const types = await apiAdapter.getAccommodationTypes();
      alert('Tipos de Acomodação:\n' + types.map(t => `${t.key} — ${t.description}`).join('\n'));
    } catch(e) {
      console.error('Failed to load accommodation types:', e);
      alert('Erro ao carregar tipos de acomodação');
    }
  });
  
  await renderAccList();
}

async function renderAccList(){
  const container = document.getElementById('acc-list');
  try {
    const list = await load(LS_KEYS.accommodations);
    if(!list || !list.length){ 
      container.innerHTML = '<div class="empty">Nenhuma acomodação</div>'; 
      return; 
    }
    container.innerHTML = list.map(a=>`
        <div class="item">
          <div>
            <div><strong>${escapeHtml(a.name || a.type)}</strong></div>
            <div class="small">${escapeHtml(a.type)} • camas solteiro ${a.CamaSolteiro || 0} • camas casal ${a.CamaCasal || 0} • climatização ${a.Climatizacao ? 'sim' : 'não'} • garagens ${a.Garagem || 0} • suítes ${a.Suite || 0} ${a.rate ? '• R$ ' + a.rate : ''}</div>
          </div>
          <div class="actions">
            <button class="btn ghost" data-action="edit" data-id="${a.id}">Editar</button>
            <button class="btn ghost" data-action="delete" data-id="${a.id}">Excluir</button>
          </div>
        </div>
      `).join('');

    // Add event listeners
    container.querySelectorAll('[data-action="edit"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.getAttribute('data-id');
        if (id) showAccForm(id);
      });
    });
  } catch (err) {
    console.error('Failed to render accommodation list:', err);
    container.innerHTML = '<div class="empty error">Erro ao carregar acomodações</div>';
  }
        <button class="btn ghost" data-action="delete" data-id="${a.id}">Excluir</button>
      </div>
    </div>
  `).join('');
  container.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.dataset.id;
      if(btn.dataset.action==='edit') showAccForm(id);
      else if(btn.dataset.action==='delete'){ 
        if(confirm('Excluir acomodação?')){ 
          removeAcc(id).catch(err => {
            console.error('Error in delete handler:', err);
            alert('Erro ao excluir acomodação');
          });
        } 
      }
    })
  })
}

async function showAccForm(id){
  try {
    const area = document.getElementById('acc-form-area');
    let a;
    if (id) {
      const items = await load(LS_KEYS.accommodations);
      a = items.find(x => x.id === id);
      if (!a) {
        console.error('Accommodation not found:', id);
        return;
      }
    } else {
      a = {
        id: '',
        name: '',
        type: 'SolteiroSimples',
        CamaSolteiro: 1,
        CamaCasal: 0,
        Climatizacao: false,
        Garagem: 0,
        Suite: 0,
        rate: 0
      };
    }

  async function loadTypes(){
    try{
      const base = window.API_BASE_URL || location.origin;
      // fetch types and specs
      const res = await fetch((base||'') + '/api/v1/accommodation-types-specs');
      if(res.ok){ const j = await res.json(); if(Array.isArray(j.data) && j.data.length) return j.data; }
      // fallback to simpler list
      const res2 = await fetch((base||'') + '/api/v1/accommodation-types');
      if(res2.ok){ const j2 = await res2.json(); return (j2.data || DEFAULT_TYPES).map(t=> ({ key: t.key, description: t.description })); }
    }catch(e){ }
    return DEFAULT_TYPES;
  }
  area.innerHTML = `
    <h3>${a.id?'Editar Acomodação':'Nova Acomodação'}</h3>
    <form id="acc-form">
      <label>Nome<input type="text" name="name" value="${escapeHtml(a.name)}" required></label>
      <div class="row">
        <label style="flex:1">Tipo<select name="type" id="acc-type-select">
          <option>Carregando...</option>
        </select></label>
      </div>
      <div class="row">

      </div>
      <div class="row">
      <label>Tarifa (R$)<input type="text" name="rate" value="${a.rate}"></label>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn" type="submit">Salvar</button>
        <button class="btn ghost" id="btn-cancel-acc" type="button">Cancelar</button>
      </div>
    </form>
  `;
  document.getElementById('btn-cancel-acc').addEventListener('click', ()=>{ area.innerHTML = '<div class="empty">Selecione uma acomodação ou crie uma nova</div>'; });
  // populate types then wire submit
  loadTypes().then(types=>{
    const sel = document.getElementById('acc-type-select');
    sel.innerHTML = types.map(t=>`<option value="${t.key}" ${t.key===a.type? 'selected':''}>${escapeHtml(t.key)} — ${escapeHtml(t.description||t.description||'')}</option>`).join('');
    // show specs read-only area
    const specsArea = document.createElement('div'); specsArea.className = 'specs';
    sel.parentNode.appendChild(specsArea);

function renderSpecsFor(key) {
  const t = types.find(tt => tt.key === key) || types[0] || {};
  const camasSolteiro = t.CamaSolteiro || t.camaSolteiro || 0;
  const camasCasal = t.CamaCasal || t.camaCasal || 0;
  const climatizacao = (t.Climatizacao || t.climatizacao) ? 'sim' : 'não';
  const garagens = t.Garagem || t.garagem || 0;
  const suites = t.Suite || t.suite || 0;

  specsArea.innerHTML = `
    <div class="spec-row"><strong>camas solteiro:</strong> ${camasSolteiro}</div>
    <div class="spec-row"><strong>camas casal:</strong> ${camasCasal}</div>
    <div class="spec-row"><strong>climatização:</strong> ${climatizacao}</div>
    <div class="spec-row"><strong>garagens:</strong> ${garagens}</div>
    <div class="spec-row"><strong>suítes:</strong> ${suites}</div>
  `;
}


    renderSpecsFor(a.type || sel.value);
    sel.addEventListener('change', ()=> renderSpecsFor(sel.value));

    document.getElementById('acc-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      
      try {
        const payload = {
          name: form.name.value.trim(),
          type: form.type.value,
          rate: parseFloat(form.rate.value) || 0
        };

        if (a.id) {
          // Update existing
          await window.apiAdapter.update(LS_KEYS.accommodations, a.id, payload);
        } else {
          // Create new
          await window.apiAdapter.create(LS_KEYS.accommodations, payload);
        }

        await renderAccList();
        area.innerHTML = '<div class="empty">Selecione uma acomodação ou crie uma nova</div>';
      } catch (err) {
        console.error('Failed to save accommodation:', err);
        alert('Erro ao salvar acomodação');
      }
      if(a.id){
        // update
        const res = await fetch((base||'') + '/api/v1/accommodations/' + a.id, { method: 'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: obj.name, type: obj.type, rate: obj.rate }) });
        if(res.ok){ 
          const data = await res.json();
          // Update in localStorage
          const list = load(LS_KEYS.accommodations);
          const index = list.findIndex(x => x.id === a.id);
          if (index !== -1) {
            list[index] = data.data;
          }
          save(LS_KEYS.accommodations, list);
          renderAccList(); 
          renderSummary(); 
          area.innerHTML = '<div class="small">Acomodação atualizada.</div>'; 
        }
        else area.innerHTML = '<div class="small">Erro ao atualizar acomodação.</div>';
      } else {
        const res = await fetch((base||'') + '/api/v1/accommodations', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: obj.name, type: obj.type, rate: obj.rate }) });
        if(res.ok){ 
          const data = await res.json();
          // Add to localStorage
          const list = load(LS_KEYS.accommodations);
          list.push(data.data);
          save(LS_KEYS.accommodations, list);
          renderAccList(); 
          renderSummary(); 
          area.innerHTML = '<div class="small">Acomodação criada.</div>'; 
        }
        else area.innerHTML = '<div class="small">Erro ao criar acomodação.</div>';
      }
    })
  });
}

async function removeAcc(id){
  try {
    await api.accommodations.delete(id);
    // Bookings with this accommodation will be automatically removed by the server
    await renderAccList();
    await renderSummary();
  } catch(err) {
    console.error('Error removing accommodation:', err);
    alert('Erro ao excluir acomodação. Por favor, tente novamente.');
  }
}

// --- Bookings (Hospedagens)
function renderBookings(container){
  container.innerHTML = `
    <div class="grid">
      <div class="card list">
        <div class="toolbar"><h2>Hospedagens</h2><button class="btn" id="btn-new-booking">Nova Hospedagem</button></div>
        <div id="bookings-list"></div>
      </div>
      <div class="card" id="booking-form-area"><div class="empty">Selecione hospedagem ou crie nova</div></div>
    </div>
  `;
  document.getElementById('btn-new-booking').addEventListener('click', ()=> showBookingForm());
  renderBookingsList();
}

function renderBookingsList(){
  const bookings = load(LS_KEYS.bookings);
  const clients = load(LS_KEYS.clients);
  const acc = load(LS_KEYS.accommodations);
  const container = document.getElementById('bookings-list');
  if(!bookings.length){ container.innerHTML = '<div class="empty">Nenhuma hospedagem registrada</div>'; return; }
  container.innerHTML = bookings.map(b=>{
    const client = clients.find(c=>c.id===b.clientId) || {name:'(cliente removido)'};
    const a = acc.find(x=>x.id===b.accommodationId) || {name:'(acomodação removida)'};
    return `
      <div class="item">
        <div>
          <div><strong>${escapeHtml(client.name)}</strong> — ${escapeHtml(a.name)}</div>
          <div class="small">${b.from} → ${b.to} • ${escapeHtml(b.notes||'')}</div>
        </div>
        <div class="actions">
          <button class="btn ghost" data-action="edit" data-id="${b.id}">Editar</button>
          <button class="btn ghost" data-action="delete" data-id="${b.id}">Cancelar</button>
        </div>
      </div>
    `
  }).join('');
  container.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.dataset.id;
      if(btn.dataset.action==='edit') showBookingForm(id);
      else if(btn.dataset.action==='delete'){ if(confirm('Cancelar hospedagem?')){ removeBooking(id); renderBookingsList(); renderSummary(); } }
    })
  })
}

function showBookingForm(id){
  const area = document.getElementById('booking-form-area');
  const bookings = load(LS_KEYS.bookings);
  // only allow titulars to create bookings
  const clients = load(LS_KEYS.clients).filter(c=> (c.tipo || c.Tipo || 'titular') === 'titular');
  const acc = load(LS_KEYS.accommodations);
  const b = id ? bookings.find(x=>x.id===id) : {id:'',clientId:'',accommodationId:'',from:'',to:'',notes:''};
  area.innerHTML = `
    <h3>${b.id? 'Editar Hospedagem' : 'Nova Hospedagem'}</h3>
    <form id="booking-form">
      <label>Cliente<select name="clientId">${clients.map(c=>`<option value="${c.id}" ${c.id===b.clientId? 'selected':''}>${escapeHtml(c.name)}</option>`).join('')}</select></label>
      <label>Acomodação<select name="accommodationId">${acc.map(a=>`<option value="${a.id}" ${a.id===b.accommodationId? 'selected':''}>${escapeHtml(a.name)} — ${escapeHtml(a.type)}</option>`).join('')}</select></label>
      <div class="row">
        <label>Entrada<input type="date" name="from" value="${b.from}"></input></label>
        <label>Saída<input type="date" name="to" value="${b.to}"></input></label>
      </div>
      <label>Observações<textarea name="notes">${escapeHtml(b.notes|| '')}</textarea></label>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn" type="submit">Salvar</button>
        <button class="btn ghost" id="btn-cancel-booking" type="button">Cancelar</button>
      </div>
    </form>
  `;
  document.getElementById('btn-cancel-booking').addEventListener('click', ()=>{ area.innerHTML='<div class="empty">Selecione hospedagem ou crie nova</div>' });
  document.getElementById('booking-form').addEventListener('submit', (e)=>{
    e.preventDefault(); const f=e.target; const obj = { id: b.id || genId(), clientId: f.clientId.value, accommodationId: f.accommodationId.value, from: f.from.value, to: f.to.value, notes: f.notes.value };
    const list = load(LS_KEYS.bookings).filter(x=>x.id!==obj.id); list.push(obj); save(LS_KEYS.bookings, list);
    renderBookingsList(); renderSummary(); area.innerHTML = '<div class="small">Hospedagem salva.</div>';
  })
}

function removeBooking(id){ const list = load(LS_KEYS.bookings).filter(x=>x.id!==id); save(LS_KEYS.bookings, list); }

// --- Utilities
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

// --- Init
// initialize app: seed then start router
seedIfEmpty().then(()=>{
  window.addEventListener('hashchange', navigate);
  window.addEventListener('load', ()=>{ navigate(); });
}).catch((e)=>{
  console.error('seedIfEmpty failed:', e);
  // still start router so UI attempts to render
  window.addEventListener('hashchange', navigate);
  window.addEventListener('load', ()=>{ navigate(); });
});
